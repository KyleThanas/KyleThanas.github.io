(window.webpackJsonp=window.webpackJsonp||[]).push([[104],{289:function(t,e,n){"use strict";n.r(e);var a=n(28),i=Object(a.a)({},(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"图片上传"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#图片上传"}},[t._v("#")]),t._v(" 图片上传")]),t._v(" "),n("div",{staticClass:"lake-content-editor-core lake-engine",attrs:{"data-lake-element":"root","data-selection-124615":"%7B%22path%22%3A%5B%5B39%2C0%2C1%2C0%2C3%2C0%2C0%2C0%5D%2C%5B39%2C0%2C1%2C0%2C3%2C0%2C0%2C0%5D%5D%2C%22uuid%22%3A%22124615%22%2C%22active%22%3Atrue%7D"}},[n("h2",{attrs:{id:"预计目标"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#预计目标"}},[t._v("#")]),t._v(" 预计目标")]),t._v(" "),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("span",{staticStyle:{color:"#98c379"}}),n("span",{attrs:{"data-card-type":"inline","data-lake-card":"image"}},[n("img",{staticClass:"image lake-drag-image",staticStyle:{visibility:"visible",width:"189px",height:"336px"},attrs:{"data-role":"image",src:"https://cdn.nlark.com/yuque/0/2019/png/124615/1569312964177-4d49de1f-fb29-4a94-b28d-d0bf171c3246.png","data-raw-src":"https://cdn.nlark.com/yuque/0/2019/png/124615/1569312964177-4d49de1f-fb29-4a94-b28d-d0bf171c3246.png",alt:"image.png",title:"image.png"}})]),n("span",{attrs:{"data-card-type":"inline","data-lake-card":"image"}},[n("img",{staticClass:"image lake-drag-image",staticStyle:{visibility:"visible",width:"189.5px",height:"336px"},attrs:{"data-role":"image",src:"https://cdn.nlark.com/yuque/0/2019/png/124615/1569313008104-25b207c9-f456-45d6-8093-0728edccc162.png","data-raw-src":"https://cdn.nlark.com/yuque/0/2019/png/124615/1569313008104-25b207c9-f456-45d6-8093-0728edccc162.png",alt:"image.png",title:"image.png"}})]),n("span",{attrs:{"data-card-type":"inline","data-lake-card":"image"}},[n("img",{staticClass:"image lake-drag-image",staticStyle:{visibility:"visible",width:"189.5px",height:"336px"},attrs:{"data-role":"image",src:"https://cdn.nlark.com/yuque/0/2019/png/124615/1569312940535-1109a310-8148-4ca4-8419-4fae383aff85.png","data-raw-src":"https://cdn.nlark.com/yuque/0/2019/png/124615/1569312940535-1109a310-8148-4ca4-8419-4fae383aff85.png",alt:"image.png",title:"image.png"}})])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),t._v(" "),n("h2",{attrs:{id:"需要的功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#需要的功能"}},[t._v("#")]),t._v(" 需要的功能")]),t._v(" "),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("em",[t._v("图片大小限制")])]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"BWtaL"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("event.preventDefault()\nconst file = event.target.files[0]\nconst fileName = file.name\nconst fileSize = file.size\nconst fileExt = fileName.split('.').pop()\nconst accept = '.jpg,.jpeg,.png'\nconst maxSize = 15 * 1024 * 1024\n\nif (accept && accept.indexOf(fileExt) === -1) {\n return Toast.show('文件类型不支持')\n}\n\nif (fileSize > maxSize) {\n return Toast.show('文件体积超出上传限制')\n} \n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("em",[t._v("图片上传")])]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"UlRbS"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("try {\n Toast.loading()\n const data = await courseUploader(newFile)\n const fileUrl = `https://${data.Location}`\n this.setState({ imageList: [fileUrl] }, Toast.hide)\n} catch (error) {\n Toast.show('上传失败')\n} finally {\n this.isLoading = false\n} \n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("em",[t._v("图片压缩")])]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"0JKd3"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("// 图片压缩\nexport const imageCompress = (file) => {\n return new Promise((resolve, reject) => {\n   const reader = new FileReader()\n   const image = new Image()\n\n   reader.readAsDataURL(file)\n   reader.onload = function(e) {\n     image.src = e.target.result\n     image.onerror = () => {\n       return reject('图像加载失败')\n     }\n     image.onload = function() {\n       const canvas = document.createElement('canvas')\n       const context = canvas.getContext('2d')\n\n       const originWidth = this.width\n       const originHeight = this.height\n       const maxWidth = 1000\n       const maxHeight = 1000\n       let targetWidth = originWidth\n       let targetHeight = originHeight\n\n       if (originWidth > maxWidth || originHeight > maxHeight) {\n         if (originWidth / originHeight > maxWidth / maxHeight) {\n           targetWidth = maxWidth\n           targetHeight = Math.round(maxWidth * (originHeight / originWidth))\n         } else {\n           targetHeight = maxHeight\n           targetWidth = Math.round(maxHeight * (originWidth / originHeight))\n         }\n       }\n\n       canvas.width = targetWidth\n       canvas.height = targetHeight\n\n       context.clearRect(0, 0, targetWidth, targetHeight)\n       context.drawImage(image, 0, 0, targetWidth, targetHeight)\n       const dataUrl = canvas.toDataURL('image/jpeg', 0.92)\n\n       return resolve(dataURLtoFile(dataUrl))\n     }\n   }\n })\n} \n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("em",[t._v("图片base64转file")])]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"elhba"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("// 图片base64转file\nexport const dataURLtoFile = (dataurl, filename = 'file') => {\n let arr = dataurl.split(',')\n let mime = arr[0].match(/:(.*?);/)[1]\n let suffix = mime.split('/')[1]\n let bstr = atob(arr[1])\n let n = bstr.length\n let u8arr = new Uint8Array(n)\n while (n--) {\n   u8arr[n] = bstr.charCodeAt(n)\n }\n return new File([u8arr], `${filename}.${suffix}`, {\n   type: mime\n })\n} \n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("em",[t._v("判断移动端图片是 竖图还是横图")])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("em",[n("a",{attrs:{href:"https://github.com/exif-js/exif-js/blob/master/README.md",target:"_blank"}},[t._v("Exif-js github文档")])])]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"table",id:"XqhgZ"}},[n("table",{staticClass:"lake-table",staticStyle:{outline:"none","border-collapse":"collapse"}},[n("colgroup",[n("col",{attrs:{width:"248",span:"1"}}),n("col",{attrs:{width:"248",span:"1"}})]),n("tbody",[n("tr",{staticStyle:{height:"33px"}},[n("td",{staticStyle:{"vertical-align":"top","background-color":"rgb(255, 255, 255)",color:"rgb(38, 38, 38)","min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"},attrs:{colspan:"1"}},[n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("strong",[t._v("orientation值")])])]),n("td",{staticStyle:{"vertical-align":"top","background-color":"rgb(255, 255, 255)",color:"rgb(38, 38, 38)","min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"},attrs:{colspan:"1",rowspan:"1"}},[n("strong",[t._v("旋转角度")])])]),n("tr",{staticStyle:{height:"33px"}},[n("td",{staticStyle:{"min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"}},[t._v("1")]),n("td",{staticStyle:{"min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"}},[t._v("0°")])]),n("tr",{staticStyle:{height:"33px"}},[n("td",{staticStyle:{"min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"}},[t._v("3")]),n("td",{staticStyle:{"min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"}},[t._v("180°")])]),n("tr",{staticStyle:{height:"33px"}},[n("td",{staticStyle:{"min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"}},[t._v("6")]),n("td",{staticStyle:{"min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"}},[t._v("顺时针90°")])]),n("tr",{staticStyle:{height:"33px"}},[n("td",{staticStyle:{"min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"},attrs:{colspan:"1"}},[t._v("8")]),n("td",{staticStyle:{"min-width":"90px","font-size":"14px","white-space":"normal","overflow-wrap":"break-word",border:"1px solid rgb(217, 217, 217)",padding:"4px 8px",cursor:"default"},attrs:{colspan:"1"}},[t._v("逆时针90°")])])])])]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"o3TkO"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("import EXIF from 'exif-js'\n// 只在移动端生效\nEXIF.getData(file, function() {\n const orient = EXIF.getTag(this, 'Orientation')\n if (orient === 6) {\n   // 竖图\n   // 做向右旋转90度度处理\n } else {\n   // 不做特殊处理\n }\n}) \n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("em",[t._v("canvas图片旋转")])]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"Ge8Sh"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("const canvas = document.createElement('canvas')\nconst context = canvas.getContext('2d')\n\n...\ncontext.clearRect(0, 0, targetWidth, targetHeight) // 清空内容区\n...\n\ncanvas.width = targetHeight // targetHeight 当前图片高度 把canvas重绘\ncanvas.height = targetWidth // targetWidth 当前图片宽度 把canvas重绘\ncontext.translate(targetHeight / 2, targetWidth / 2) // 设置当前图的中心区域\ncontext.rotate(90 * Math.PI / 180) // 向右旋转90度\ncontext.drawImage(image, -targetWidth / 2, -targetHeight / 2, targetWidth, targetHeight) \n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),t._v(" "),n("h2",{attrs:{id:"完整代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#完整代码"}},[t._v("#")]),t._v(" 完整代码")]),t._v(" "),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[t._v("index.js")]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"n3HVu"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("import { PureComponent, Fragment, createRef } from 'react'\nimport DocumentTitle from 'react-document-title'\nimport Textarea from 'react-textarea-autosize'\nimport router from 'umi/router'\nimport styled from 'styled-components'\nimport classnames from 'classnames'\nimport { courseUploader } from '@@/utils/cos'\nimport { imageCompress } from '@@/utils/imageCrop'\nimport Toast from '@@/components/Toast'\nimport withStyled from '@@/styles/withStyled'\nimport notrService from '@@/services/note'\nimport wx from 'weixin-js-sdk'\n\nimport iconCloseGray from '@@/assets/icons/icon-close-gray.png'\nimport iconImg from '@@/assets/icons/icon-img.png'\n\nconst NoteController = withStyled(styled.div`\n position: fixed;\n top: 0;\n left: 0;\n right: 0;\n z-index: 100;\n margin: 0 auto;\n padding: 9px 24px;\n display: flex;\n max-width: 480PX;\n align-items: center;\n justify-content: flex-end;\n width: 100%;\n background-color: #F9FAFC;\n`)\n\nconst NoteChooseImage = withStyled(styled.div`\n margin: 0 24px 0 0;\n width: 24px;\n height: 24px;\n background-size: 100%;\n background-repeat: no-repeat;\n background-image: url(${iconImg});\n &.notouch {\n   filter: opacity(0.5);\n }\n`)\n\nconst InputForImage = withStyled(styled.input`\n display: none;\n`)\n\nconst NotePublish = withStyled(styled.div`\n padding: 9px 20px;\n font-size: 14px;\n color: #222222;\n background-color: ${(props) => props.theme.primaryColor};\n border-radius: 16px;\n`)\n\nconst ImageArea = withStyled(styled.div`\n padding: 0 24px 24px;\n display: flex;\n flex-wrap: wrap;\n width: 100%;\n height: auto;\n`)\n\nconst ImageDisplay = withStyled(styled.div`\n position: relative;\n margin: 0 0 10px;\n width: 96px;\n height: 96px;\n background-position: center;\n background-size: 100%;\n background-repeat: no-repeat;\n background-image: url(${(props) => props.image});\n border-radius: 8px;\n &:nth-of-type(3n-1) {\n   margin: 0 auto 10px;\n }\n`)\n\nconst ImageDelete = withStyled(styled.div`\n position: absolute;\n top: 4PX;\n right: 4PX;\n width: 16PX;\n height: 16PX;\n background-size: 100%;\n background-repeat: no-repeat;\n background-image: url(${iconCloseGray});\n border-radius: 50%;\n`)\n\nconst textareaStyle = {\n marginTop: 60, paddingLeft: 24, paddingRight: 24, paddingBottom: 24, width: '100%', fontSize: 16, color: '#475669', lineHeight: 2, border: 0, resize: 'none'\n}\n\nclass CreatePage extends PureComponent {\n constructor(props) {\n   super(props)\n   const { match: { params: { uniqueId } } } = this.props\n   this.uniqueId = uniqueId\n   this.inputNode = createRef()\n   this.isLoading = false\n   this.state = {\n     text: '',\n     notouch: false,\n     imageList: []\n   }\n }\n\n action = {\n   handleImageClick: () => {\n     const { imageList } = this.state\n\n     if (imageList.length !== 0) {\n       return Toast.show('只能上传一张图片')\n     }\n     this.inputNode.current.click()\n   },\n   handleImageChange: async (event) => {\n     event.preventDefault()\n     if (this.isLoading) {\n       return false\n     }\n\n     const file = event.target.files[0]\n     const fileName = file.name\n     const fileSize = file.size\n     const fileExt = fileName.split('.').pop()\n     const accept = '.jpg,.jpeg,.png'\n     const maxSize = 15 * 1024 * 1024\n\n     if (accept && accept.indexOf(fileExt) === -1) {\n       return Toast.show('文件类型不支持')\n     }\n\n     if (fileSize > maxSize) {\n       return Toast.show('文件体积超出上传限制')\n     }\n\n     this.isLoading = true\n     const newFile = await imageCompress(file)\n     try {\n       Toast.loading()\n       const data = await courseUploader(newFile)\n       const fileUrl = `https://${data.Location}`\n       this.setState({ imageList: [fileUrl], notouch: true }, Toast.hide)\n     } catch (error) {\n       Toast.show('上传失败')\n     } finally {\n       this.isLoading = false\n     }\n   },\n   handleDelete: (index, event) => {\n     event.stopPropagation()\n     const imageList = [...this.state.imageList]\n     imageList.splice(index, 1)\n     this.setState({ imageList, notouch: false })\n   },\n   handleNoteChange: (e) => {\n     this.setState({ text: e.target.value })\n   },\n   handleFetch: async () => {\n     const len = this.state.text.length\n     if (len >= 10 && len <= 1000) {\n       try {\n         Toast.loading()\n         await notrService.writeNote(this.uniqueId, {\n           noteContent: this.state.text,\n           imageUrl: this.state.imageList\n         })\n         setTimeout(() => {\n           Toast.show('笔记发表成功')\n           const pathname = `/note/${this.uniqueId}`\n           router.replace({\n             pathname,\n             query: {\n               tabKey: 'mine'\n             }\n           })\n         }, 500)\n       } catch (error) {\n         setTimeout(() => { Toast.show(error.message) }, 500)\n       }\n     } else {\n       Toast.show('笔记内容字数错误，字数在10-1000内')\n     }\n   },\n   previewImage: (event) => {\n     event.stopPropagation()\n     wx.previewImage({\n       current: this.state.imageList[0], // 当前显示图片的http链接\n       urls: this.state.imageList // 需要预览的图片http链接列表\n     })\n   }\n }\n\n render() {\n   const { text, imageList, notouch } = this.state\n   return (\n     <documenttitle title=\"写笔记\">\n       <fragment>\n         <notecontroller>\n           <inputforimage ref=\"{this.inputNode}\" type=\"file\" accept=\"image/*\" onclick=\"{(e)\" => { e.target.value = '' }} onChange={this.action.handleImageChange} />\n           <notechooseimage classname=\"{classnames({\" notouch })} onclick=\"{this.action.handleImageClick}\">\n           <notepublish onclick=\"{this.action.handleFetch}\">发表</notepublish>\n         </notechooseimage></inputforimage></notecontroller>\n         <textarea minrows=\"{5}\" placeholder=\"记录学习后的珍贵收获~\" value=\"{text}\" onchange=\"{this.action.handleNoteChange}\" style=\"{textareaStyle}\">          {imageList.length !== 0 && (\n           <ImageArea>\n             {imageList.map((item, index) => (\n               <ImageDisplay image={item} key={index} onClick={this.action.previewImage}>\n                 <ImageDelete onClick={(event) => this.action.handleDelete(index, event)} />\n               </ImageDisplay>\n             ))}\n           </ImageArea>\n         )}\n       </Fragment>\n     </DocumentTitle>\n   )\n }\n}\n\nexport default CreatePage \n")])])]),n("p")])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[t._v("imageCrop.js")]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"VQVFl"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("p"),t._v(" "),n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("import { getClientWidth } from '@@/utils/dom'\nimport EXIF from 'exif-js'\n\nconst clientWidth = getClientWidth()\nconst maxImageWidth = clientWidth >= 480 ? 480 : clientWidth\n\n// 浏览器是否支持 webp 图片格式\nexport const isWebpSupport = () => {\n const dataUrl = document.createElement('canvas').toDataURL('image/webp')\n return dataUrl.indexOf('data:image/webp') === 0\n}\n\n// 根据屏幕分辨率获取长度\nconst getImageLength = (length) => {\n const imageLength = Math.floor(Number(length) || 0) || maxImageWidth\n return window.devicePixelRatio * imageLength\n}\n\n// 腾讯数据万象图片链接拼接\n// 参考文档 https://cloud.tencent.com/document/product/460/6929\nexport const fasterImageUrl = (imageUrl, options) => {\n if (!imageUrl || !String(imageUrl).startsWith('http')) {\n   return imageUrl\n }\n\n const { width } = Object.assign({}, options)\n const imageWidth = getImageLength(width)\n\n const formatSuffix = isWebpSupport() ? '/format/webp' : ''\n const widthSuffix = `/w/${imageWidth}`\n\n return `${imageUrl}?imageView2/2${formatSuffix}${widthSuffix}`\n}\n\n// 获取分享链接小图标\nexport const getShareImageUrl = (imageUrl) => {\n if (!imageUrl || !String(imageUrl).startsWith('http')) {\n   return imageUrl\n }\n\n return `${imageUrl}?imageView2/2/w/200`\n}\n\n// 图片base64转file\nexport const dataURLtoFile = (dataurl, filename = 'file') => {\n let arr = dataurl.split(',')\n let mime = arr[0].match(/:(.*?);/)[1]\n let suffix = mime.split('/')[1]\n let bstr = atob(arr[1])\n let n = bstr.length\n let u8arr = new Uint8Array(n)\n while (n--) {\n   u8arr[n] = bstr.charCodeAt(n)\n }\n return new File([u8arr], `${filename}.${suffix}`, {\n   type: mime\n })\n}\n\n// 图片压缩 并 判断是否需要旋转\nexport const imageCompress = (file) => {\n return new Promise((resolve, reject) => {\n   const reader = new FileReader()\n   const image = new Image()\n\n   reader.readAsDataURL(file)\n   reader.onload = function(e) {\n     image.src = e.target.result\n     image.onerror = () => {\n       return reject('图像加载失败')\n     }\n     image.onload = function() {\n       const canvas = document.createElement('canvas')\n       const context = canvas.getContext('2d')\n\n       const originWidth = this.width\n       const originHeight = this.height\n       const maxWidth = 1000\n       const maxHeight = 1000\n       let targetWidth = originWidth\n       let targetHeight = originHeight\n\n       if (originWidth > maxWidth || originHeight > maxHeight) {\n         if (originWidth / originHeight > maxWidth / maxHeight) {\n           targetWidth = maxWidth\n           targetHeight = Math.round(maxWidth * (originHeight / originWidth))\n         } else {\n           targetHeight = maxHeight\n           targetWidth = Math.round(maxHeight * (originWidth / originHeight))\n         }\n       }\n\n       context.clearRect(0, 0, targetWidth, targetHeight)\n       // 图片翻转问题解决方案\n       // 在移动端，手机拍照后图片会左转90度，下面的函数恢复旋转问题\n       // orient = 6时候，是图片竖着拍的\n       EXIF.getData(file, function() {\n         const orient = EXIF.getTag(this, 'Orientation')\n         if (orient === 6) {\n           canvas.width = targetHeight\n           canvas.height = targetWidth\n           context.translate(targetHeight / 2, targetWidth / 2)\n           context.rotate(90 * Math.PI / 180)\n           context.drawImage(image, -targetWidth / 2, -targetHeight / 2, targetWidth, targetHeight)\n         } else {\n           canvas.width = targetWidth\n           canvas.height = targetHeight\n           context.drawImage(image, 0, 0, targetWidth, targetHeight)\n         }\n         const dataUrl = canvas.toDataURL('image/jpeg', 0.8)\n         return resolve(dataURLtoFile(dataUrl))\n       })\n     }\n   }\n })\n}\n\n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("span",[t._v("腾讯云存储照片  ")]),n("span",[t._v("cos.js+")]),n("span",[t._v("utils.js")])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[t._v("cos.js")]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"X6IIO"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("import COS from 'cos-js-sdk-v5'\nimport UUID from 'uuid/v4'\nimport utilsService from '@@/services/utils'\n\n// 创建认证实例\nconst courseInstance = new COS({\n getAuthorization: async (options, callback) => {\n   const uploadKey = await utilsService.getUploadKey(options)\n   callback(uploadKey)\n }\n})\n\n// 获取分片上传实例\nconst getUploader = (instance, region, bucket) => {\n return (file) => {\n   const fileName = file.name\n   const fileExt = fileName.split('.').pop()\n   const fileHash = UUID()\n   const fileKey = fileName === fileExt ? `client/${fileHash}` : `client/${fileHash}.${fileExt}`\n\n   return new Promise((resolve, reject) => {\n     instance.sliceUploadFile({\n       Region: region,\n       Bucket: bucket,\n       Key: fileKey,\n       Body: file\n     }, (error, data) => {\n       if (error) {\n         return reject(error)\n       }\n       return resolve(data)\n     })\n   })\n }\n}\n\nexport const courseUploader = getUploader(courseInstance, 'ap-beijing', 'course-1252068037')\n\n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[t._v("utils.js")]),n("div",{attrs:{"data-card-type":"block","data-lake-card":"codeblock",id:"3ml5i"}},[n("div",{staticClass:"lake-codeblock-content",staticStyle:{border:"1px solid rgb(232, 232, 232)","max-width":"750px",color:"rgb(38, 38, 38)",margin:"0px",padding:"0px",background:"rgb(249, 249, 249)"}},[n("div",{staticStyle:{color:"rgb(89, 89, 89)",margin:"0px",padding:"16px",background:"none 0% 0% / auto repeat scroll padding-box border-box rgba(0, 0, 0, 0)"}},[n("div",{staticClass:"language-undefined extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("import { courseRequest as Axios } from '@@/utils/axios'\n\nclass UtilsService {\n async getUploadKey() {\n   const { data: { credentials, expiredTime } } = await Axios.get('/util/get-temporary-key', {\n     params: {\n       durationSeconds: 60 * 60\n     }\n   })\n\n   const { tmpSecretId, tmpSecretKey, sessionToken } = credentials\n   return {\n     TmpSecretId: tmpSecretId,\n     TmpSecretKey: tmpSecretKey,\n     XCosSecurityToken: sessionToken,\n     ExpiredTime: expiredTime\n   }\n }\n}\n\nexport default new UtilsService() \n")])])])])])]),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),t._v(" "),n("h2",{attrs:{id:"莫名的坑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#莫名的坑"}},[t._v("#")]),t._v(" 莫名的坑")]),t._v(" "),n("p",{staticStyle:{"font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[n("br")]),n("ol",{staticStyle:{"list-style-type":"decimal",margin:"0px","padding-left":"23px","font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word"},attrs:{start:"1","lake-indent":"0"}},[n("li",[t._v("在安卓上无法上传图片的问题，不能触发onChange，解决办法 修改"),n("strong",[n("em",[n("span",[t._v("accept")])])]),n("span",[t._v("为：")]),t._v(" "),n("strong",[n("em",[t._v("accept")])]),n("strong",[n("span",{staticStyle:{color:"#56b6c2"}},[t._v("=")]),n("span",{staticStyle:{color:"#98c379"}},[t._v("'image/*'")])])])]),n("p",{staticStyle:{"padding-left":"2em","text-indent":"2em","font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word",margin:"0px"}},[t._v("详细解释：如果在input上面添加了"),n("em",[n("span",[t._v("accept字段，并且设置了一些值（png,jpeg,jpg），会发现，有的安卓是触发不了onChange，因为在")])]),n("em",[n("span",[t._v("accept的时候发生了拦截，使input的值未发生改变，所以建议使用")])]),n("strong",[n("em",[t._v("accept")])]),n("strong",[n("span",{staticStyle:{color:"#56b6c2"}},[t._v("=")])]),n("strong",[n("span",{staticStyle:{color:"#98c379"}},[t._v("'image/*'")])]),n("span",{staticStyle:{color:"#000000"}},[t._v("，在onChange里面写格式判断。")])]),n("ol",{staticStyle:{"list-style-type":"decimal",margin:"0px","padding-left":"23px","font-size":"14px",color:"rgb(38, 38, 38)","line-height":"24px","letter-spacing":"0.05em","outline-style":"none","overflow-wrap":"break-word"},attrs:{start:"2","lake-indent":"0"}},[n("li",[t._v("自动打开相机，而没有让用户选择相机或相册，解决办法 去掉  "),n("span",{staticStyle:{color:"#000000"}},[n("strong",[n("em",[t._v("capture")])])]),n("strong",[n("span",{staticStyle:{color:"#98c379"}},[n("em",[t._v('="camera"')])])])]),n("li",[n("strong",[t._v("手机拍照，或者手机里面度竖图")]),t._v("，发生左转90度的变化，就需要"),n("strong",[t._v("单独判断是不是竖图，然后向右旋转")])])])])])}),[],!1,null,null,null);e.default=i.exports}}]);