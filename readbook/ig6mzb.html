<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>在 model 中请求服务端数据 | Ant Design 1111</title>
    <meta name="description" content="基于 umi 的 Ant Design 1111">
    
    
    <link rel="preload" href="/readbook/assets/css/0.styles.d6f0e1c6.css" as="style"><link rel="preload" href="/readbook/assets/js/app.205826b5.js" as="script"><link rel="preload" href="/readbook/assets/js/2.6adc2b3f.js" as="script"><link rel="preload" href="/readbook/assets/js/18.45ae2ea1.js" as="script"><link rel="prefetch" href="/readbook/assets/js/10.1636d440.js"><link rel="prefetch" href="/readbook/assets/js/11.70bf2f3a.js"><link rel="prefetch" href="/readbook/assets/js/12.a107a538.js"><link rel="prefetch" href="/readbook/assets/js/13.33cb767d.js"><link rel="prefetch" href="/readbook/assets/js/14.f9871772.js"><link rel="prefetch" href="/readbook/assets/js/15.a8ea189d.js"><link rel="prefetch" href="/readbook/assets/js/16.288634c2.js"><link rel="prefetch" href="/readbook/assets/js/17.097f1891.js"><link rel="prefetch" href="/readbook/assets/js/19.8e74b4bc.js"><link rel="prefetch" href="/readbook/assets/js/20.6000349f.js"><link rel="prefetch" href="/readbook/assets/js/21.8853e1e1.js"><link rel="prefetch" href="/readbook/assets/js/22.90d3a464.js"><link rel="prefetch" href="/readbook/assets/js/23.fabe9af3.js"><link rel="prefetch" href="/readbook/assets/js/24.af897bcf.js"><link rel="prefetch" href="/readbook/assets/js/25.bc2baf43.js"><link rel="prefetch" href="/readbook/assets/js/26.ec5f48b3.js"><link rel="prefetch" href="/readbook/assets/js/27.284db135.js"><link rel="prefetch" href="/readbook/assets/js/28.8da8020e.js"><link rel="prefetch" href="/readbook/assets/js/29.642ed6af.js"><link rel="prefetch" href="/readbook/assets/js/3.516fd641.js"><link rel="prefetch" href="/readbook/assets/js/30.c42dcde0.js"><link rel="prefetch" href="/readbook/assets/js/31.5bf0ad56.js"><link rel="prefetch" href="/readbook/assets/js/32.28c4b9fc.js"><link rel="prefetch" href="/readbook/assets/js/33.8ba11b1c.js"><link rel="prefetch" href="/readbook/assets/js/34.f1f06cae.js"><link rel="prefetch" href="/readbook/assets/js/4.bb3de599.js"><link rel="prefetch" href="/readbook/assets/js/5.f324cf32.js"><link rel="prefetch" href="/readbook/assets/js/6.713fbf29.js"><link rel="prefetch" href="/readbook/assets/js/7.ea44b13f.js"><link rel="prefetch" href="/readbook/assets/js/8.19cb361c.js"><link rel="prefetch" href="/readbook/assets/js/9.12521701.js">
    <link rel="stylesheet" href="/readbook/assets/css/0.styles.d6f0e1c6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/readbook/" class="home-link router-link-active"><!----> <span class="site-name">Ant Design 1111</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/readbook/intro.html" class="sidebar-link">前言</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第一章: 基础知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/readbook/sc1lvc.html" class="sidebar-link">前端开发的演变</a></li><li><a href="/readbook/wybhm9.html" class="sidebar-link">初始化项目</a></li><li><a href="/readbook/fd5af7.html" class="sidebar-link">第一个组件</a></li><li><a href="/readbook/agmsgo.html" class="sidebar-link">使用 Ant Design 组件</a></li><li><a href="/readbook/goozth.html" class="sidebar-link">受控组件与非受控组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/readbook/chapter2.html" class="sidebar-heading clickable"><span>第二章: 布局与路由</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/readbook/layout.html" class="sidebar-link">基本布局</a></li><li><a href="/readbook/ghalng.html" class="sidebar-link">侧边导航</a></li><li><a href="/readbook/ipsba8.html" class="sidebar-link">路由配置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/readbook/chapter3.html" class="sidebar-heading clickable open"><span>第三章: 小试牛刀</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/readbook/abl3ad.html" class="sidebar-link">使用 model</a></li><li><a href="/readbook/dsl8ee.html" class="sidebar-link">搭建基于 model 的卡片列表页面</a></li><li><a href="/readbook/ig6mzb.html" class="active sidebar-link">在 model 中请求服务端数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/readbook/ig6mzb.html#一点点理论：effect-和-generator-function" class="sidebar-link">一点点理论：Effect 和 Generator function</a></li><li class="sidebar-sub-header"><a href="/readbook/ig6mzb.html#一个-活-的-dva-model：使用-effect-获取真实数据源数据" class="sidebar-link">一个&quot;活&quot;的 dva model：使用 Effect 获取真实数据源数据</a></li><li class="sidebar-sub-header"><a href="/readbook/ig6mzb.html#代理请求" class="sidebar-link">代理请求</a></li></ul></li><li><a href="/readbook/kmmq56.html" class="sidebar-link">模拟服务端数据</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/readbook/chapter4.html" class="sidebar-heading clickable"><span>第四章: 复杂页面</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/readbook/ndfx96.html" class="sidebar-link">表格</a></li><li><a href="/readbook/up1dn3.html" class="sidebar-link">表单</a></li><li><a href="/readbook/dk8xsp.html" class="sidebar-link">图表</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第五章: 进阶功能</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/readbook/customized_styles.html" class="sidebar-link">自定义样式</a></li><li><a href="/readbook/wvbsue.html" class="sidebar-link">上传与下载</a></li><li><a href="/readbook/aut0sr.html" class="sidebar-link">国际化</a></li><li><a href="/readbook/lifemethods.html" class="sidebar-link">React 的生命周期</a></li><li><a href="/readbook/auth.html" class="sidebar-link">权限</a></li><li><a href="/readbook/unittest.html" class="sidebar-link">单元测试</a></li><li><a href="/readbook/typescript.html" class="sidebar-link">使用 TypeScript</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>附录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/readbook/byllph.html" class="sidebar-link">你需要了解的 ES6 语法</a></li><li><a href="/readbook/tydf0a.html" class="sidebar-link">深入理解 umi</a></li><li><a href="/readbook/about.html" class="sidebar-link">关于我们</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="在-model-中请求服务端数据"><a href="#在-model-中请求服务端数据" aria-hidden="true" class="header-anchor">#</a> 在 model 中请求服务端数据</h1> <p>在前面的章节中，我们体验了 model 的使用。如果说 model，namespace，connect，dispatch，action，reducer 这些是 dva 的基石，那 dva 的精髓就体现在于 effect。本章中涉及的 demo 代码请访问 <a href="https://github.com/ant-design/react-tutorial" target="_blank" rel="noopener noreferrer">https://github.com/ant-design/react-tutorial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。</p> <h2 id="一点点理论：effect-和-generator-function"><a href="#一点点理论：effect-和-generator-function" aria-hidden="true" class="header-anchor">#</a> 一点点理论：Effect 和 Generator function</h2> <p>在之前的例子中，我们没有在 reducer 中做任何的异步操作，但在实际的开发中，计算新 state 时常常需要异步操作配合，比如说强制延时、异步网络请求数据（比如 ajax）等等。但是 reducer 需要是个纯函数，我们不能在 reducer 中写这些逻辑，破坏了这个机制后 dva 将无法工作。在 dva 框架下，effect 就是专门处理这些具有 &quot;副作用&quot; 的操作的执行单元。</p> <p>那么 effect 到底是什么呢 ？effect 是一个 dva 语境中的名词。和 reducers 类似，我们也可以在 dva model 中定义一个 <code>effects</code> 成员。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  namespace<span class="token punctuation">:</span> <span class="token string">'some_namespace'</span><span class="token punctuation">,</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  effects<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 定义 effects 成员</span>
    <span class="token string">'someEffect'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'someOtherEffect'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  reducers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>局部上看 effect 就是一个一个的 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*" target="_blank" rel="noopener noreferrer">generator function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。宏观上看，effect 是一层中间件。</strong></p> <h3 id="effect-和-middleware"><a href="#effect-和-middleware" aria-hidden="true" class="header-anchor">#</a> effect 和 middleware</h3> <p>我们先展示 effect 是怎样作为中间件存在的。中间件是一种程序架构和分布式系统架构上的思想。目前来讲还没有个标准定义，笔者认为起码在程序架构领域下面一句话还是比较准确精炼的。</p> <blockquote><p>&quot; Middleware is some code you can put between the framework receiving a request, and the framework generating a response. &quot;</p></blockquote> <p>在上一章中 action 被 dispatch 之后就能够 <em>直接</em> 到达 reducer。为了保证 reducer 的纯粹性，但同时又能够处理副作用，就需要打破「直接」这个特性。effect 充当了这么一个中间层，当 action 被 dispatch 之后，会先到达 effect 处理副作用，然后该 effect 最终会促使新的 action 发送出去，这个新的 action 可能被其他的 effect 再捕获继续处理，也可能被 reducer 捕获并结束，无论怎样，最终处理逻辑的终点都将是 reducer。</p> <p>在上一章节中，我们知道 action.type 的构造是 <code>namespace 名称</code> + <code>/</code> + <code>reducer 名称</code>，事实上 action.type 也可以是 <code>namespace 名称</code> + <code>/</code> + <code>effect 名称</code>。对于视图层来讲，其实并不会感知 effect 和 reducer 的区别。视图层只是通过 action 描述想做什么，至于这个 action 之后是直接被 reducer 处理还是通过 effect 再到 reducer，视图层并不感知，也不应该关心。这样我们就做到了数据逻辑和视图逻辑的分离处理。</p> <h3 id="generator-function"><a href="#generator-function" aria-hidden="true" class="header-anchor">#</a> Generator function</h3> <p>我们再解释为什么 generator function 可以用来处理异步逻辑。其实 generator function 处理异步逻辑并不是 dva 的专利，在许多 js 框架中都用到了，最著名的就是 co。使用 generator function 处理异步也不是对语言特性的乱用，而是说 generator function 天然地就具备处理异步的特质。dva 中一个典型的 effect 的写法是：</p> <div class="language-js extra-class"><pre class="language-js"><code>getData<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> payload <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> call<span class="token punctuation">,</span> put <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>SomeService<span class="token punctuation">.</span>getEndpointData<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> <span class="token string">'maybeSomeOtherParams'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'getData_success'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>先说结论：当这个 generator function 被执行时，执行的流程 <strong>看上去</strong> 会是同步的！入参有两个对象，第一个对象就是匹配这个 effect 的 action 对象，因此可以取到约定的 payload 这个字段，第二个对象是 <em>effect 原语集</em>，其中 <code>call</code>, <code>put</code> 最为常用。generator function 入参中的两个对象都是在运行时由 dva 注入到 generator function 中的。<code>call</code> 其实是一个函数，和 <code>yield</code> 关键字配合使用处理异步逻辑，call 第一个参数是一个函数，要求函数返回 Promise，之后的参数是该函数调用时的入参。yield call 调用后就阻塞了，Promise 被解析后，得到异步调用的结果，存储到 data 中，然后程序才能继续进行。看到下面一行又执行了 put。<code>put</code> 也是一个函数，put 和 <code>yield</code> 配合使用，用来派发一个 action，和 dispatch 的功能 <strong>一模一样</strong>！只不过是在 effect 函数中使用而已。</p> <blockquote><p>注意：<code>yield put</code> 派发的 action 如果是为了触发 <em>同 model</em> 中的其他 effect/reducer 执行，不需要指定 namespace 名称。</p></blockquote> <p>再聊聊 generator function 是如何优雅地把异步变得像「同步」一样。我们都知道在古老的 js 开发中，都是使用层层回调来处理异步逻辑的。但结果是：</p> <p><img src="https://cdn.nlark.com/lark/0/2018/png/58329/1533266631038-14a1996b-02d4-47d6-ae6d-f7cbe97d9cf5.png" alt="image.png | left | 747x349"></p> <p>这就是所谓的 callback hell! 程序变得很难以理解和维护。<strong>异步的实质是事件发生促使程序的执行点来回跳转。我们使用 callback 本质上是描述跳转的一种手段。generator function 并没有改变异步的本质，只是改变了描述的方式，使得程序看起来像是同步一样。</strong></p> <p>一个 generator function 在执行时有 <strong>两方</strong>。一方是 generator function 本身，另一方是 generator function 的句柄持有者，而这一般都是框架所持有。我们姑且称这个句柄为 genStub。当框架调用 genStub.next() 时，generator function 会执行到下一个 <code>yield</code> 然后暂停，并把 yield 后面表达式的计算值返还给框架，同时把程序执行权交给框架。框架拿到值后做处理，比如就是异步处理，处理结束拿到结果，再次调用 genStub.next()，返还值给 generator function 同时驱动它恢复执行。当恢复执行时，你可以认为 <strong>返回的处理结果会整体替换 <code>yield &lt;expression&gt;</code></strong>，然后程序继续执行到下一个 yield。</p> <blockquote><p>yield 这个单词用在这里特别形象：yield 本身有「让步」的意思，也有「产出」的意思。</p></blockquote> <p><strong>「generator function yield 到外部的值」和「外部返还给 generator function 的值」不是一回事！！！</strong></p> <p>generator function 定义了流程，并在每次 yield 节点上报想做的事情。而异步的真正执行逻辑由 generator function 句柄的持有者代为执行。对应到 dva 上也是一样的。拿 call 做例子，call 其实是一个<a href="https://redux-saga.js.org/docs/basics/DeclarativeEffects.html" target="_blank" rel="noopener noreferrer">特别简单的函数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。call 的返回值只是一个 plain javascript object:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token constant">CALL</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    fn<span class="token punctuation">:</span> SomeService<span class="token punctuation">.</span>getEndpointData<span class="token punctuation">,</span>
    args<span class="token punctuation">:</span> <span class="token punctuation">[</span>payload<span class="token punctuation">,</span> <span class="token string">'maybeSomeOtherParams'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们通过 call 向 dva 描述了想做的事情：请帮我执行这个函数，Promise 解析后通知我继续执行，并把 Promise 的解析值返回给我。</p> <h2 id="一个-活-的-dva-model：使用-effect-获取真实数据源数据"><a href="#一个-活-的-dva-model：使用-effect-获取真实数据源数据" aria-hidden="true" class="header-anchor">#</a> 一个&quot;活&quot;的 dva model：使用 Effect 获取真实数据源数据</h2> <p>接下来我们要改造我们的代码，我们将从真实的服务端数据源获取卡片数据。</p> <p>首先是页面文件代码：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Card <span class="token comment">/* ,Button */</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'dva'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> namespace <span class="token operator">=</span> <span class="token string">'puzzlecards'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">mapStateToProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cardList <span class="token operator">=</span> state<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    cardList<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">mapDispatchToProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    onDidMount<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>namespace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/queryInitCards`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

@<span class="token function">connect</span><span class="token punctuation">(</span>mapStateToProps<span class="token punctuation">,</span> mapDispatchToProps<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">PuzzleCardsPage</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>cardList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>card <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Card</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>card<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Q: </span><span class="token punctuation">{</span>card<span class="token punctuation">.</span>setup<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">A: </span><span class="token punctuation">{</span>card<span class="token punctuation">.</span>punchline<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
                </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
              </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Card</span><span class="token punctuation">&gt;</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后是 model 的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'../util/request'</span><span class="token punctuation">;</span>  <span class="token comment">// request 是 demo 项目脚手架中提供的一个做 http 请求的方法，是对于 fetch 的封装，返回 Promise</span>

<span class="token keyword">const</span> <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token punctuation">(</span>millisecond<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> millisecond<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  namespace<span class="token punctuation">:</span> <span class="token string">'puzzlecards'</span><span class="token punctuation">,</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    counter<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
  effects<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token function">queryInitCards</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> sagaEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> call<span class="token punctuation">,</span> put <span class="token punctuation">}</span> <span class="token operator">=</span> sagaEffects<span class="token punctuation">;</span>
      <span class="token keyword">const</span> endPointURI <span class="token operator">=</span> <span class="token string">'https://08ad1pao69.execute-api.us-east-1.amazonaws.com/dev/random_joke'</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> puzzle <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> endPointURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'addNewCard'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> puzzle <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> puzzle2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> endPointURI<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'addNewCard'</span><span class="token punctuation">,</span> payload<span class="token punctuation">:</span> puzzle2 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  reducers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">addNewCard</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> payload<span class="token punctuation">:</span> newCard <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> nextCounter <span class="token operator">=</span> state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> newCardWithId <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>newCard<span class="token punctuation">,</span> id<span class="token punctuation">:</span> nextCounter <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> nextData <span class="token operator">=</span> state<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>newCardWithId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> nextData<span class="token punctuation">,</span>
        counter<span class="token punctuation">:</span> nextCounter<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>下面同时展示了 <code>../util/request</code> 的代码，同样的代码您也可以在 demo 代码仓库中找到。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">checkStatus</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
  error<span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span>
  <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Requests a URL, returning a promise.
 *
 * @param  {string} url       The URL we want to request
 * @param  {object} [options] The options we want to pass to &quot;fetch&quot;
 * @return {object}           An object containing either &quot;data&quot; or &quot;err&quot;
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">checkStatus</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>得到新的页面：</p> <p><img src="https://cdn.nlark.com/lark/0/2018/png/58329/1533270590907-6c5bb27e-51da-4f30-809f-f1d8ce212be4.png" alt="image.png | left | 747x250"></p> <p>我们看到卡片数据不再是写死的，而真的是从服务端获取的，我们故意打开了Chrome DevTool 中的 Network 面板用来印证。</p> <blockquote><p>说明：</p> <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" target="_blank" rel="noopener noreferrer">fetch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个 W3C 标准下的基于 Promise 的做 ajax 请求的函数，但是并不那么好用。我们这里的 request 是对它的一层封装。<strong>总而言之，你在 demo 项目中可以使用 request 做 ajax 请求，该函数返回 Promise。</strong></li> <li>request 函数不指定 http verb 时默认是 GET 请求。这里仅仅演示了 HTTP GET 请求。但其他类型的异步请求也是同理可以处理。</li></ul></blockquote> <p>我们来分析一下都做了哪些改变，先从 model 说起。我们看到首先添加了一个 effect <code>queryInitCards</code>，根据我们上面的分析，如果派发了一个 type 为 <code>puzzlecards/queryInitCards</code> action，那么接下来会先到达 queryInitCards 这个 effect 来处理。接下来的流程是:</p> <ul><li><code>const puzzle = yield call(request, endPointURI);</code> 获取服务端数据。</li> <li><code>yield put({type: 'addNewCard', payload: puzzle });</code> 添加一个卡片数据。这个会触发 reducer 的执行。于是会看到视图上添加了一个新卡片。</li> <li><code>yield call(delay, 3000);</code> 暂停 3 s.</li> <li><code>const puzzle2 = yield call(request, endPointURI);</code> 第二次获取服务端数据。</li> <li><code>yield put({type: 'addNewCard', payload: puzzle });</code> 再添加一个卡片数据。这个又会触发 reducer 的执行。于是看到第二个卡片添加到视图上去。</li></ul> <p>再看看页面的改变。我们通过 mapDispatchToProps 给页面注入方法 onDidMount。页面在 mount 完毕后调用该方法。它发送一个 <code>puzzlecards/queryInitCards</code> 的 action，这个请求被 puzzlecards 中的 queryInitCards 这个 effects 所处理。这样子数据的流转就完整了。</p> <blockquote><p>在 React 16 中，页面初始化时的异步请求必须只能在 componentDidMount 中做，不能在 constructor, UNSAFE_componentWillMount, UNSAFE_componentWillReceiveProps, getDerivedStateFromProps 中做。</p></blockquote> <p>整体的数据流向见下图：</p> <p><img src="https://gw.alipayobjects.com/zos/rmsportal/ZSCxeNAFqHgKXsyjtpxt.png" alt="effects_data_flow.png | center | 747x455"></p> <h2 id="代理请求"><a href="#代理请求" aria-hidden="true" class="header-anchor">#</a> 代理请求</h2> <p>如果做到这一步，你应该非常欣喜。新技能 get! 但是这里有一个问题被回避了：跨域问题。</p> <p>请重新审视我们的请求：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> endPointURI <span class="token operator">=</span> <span class="token string">'https://08ad1pao69.execute-api.us-east-1.amazonaws.com/dev/random_joke'</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们直接调用了一个「非本地」地址。在实际开发中是比较罕见的。这里能够成功，是因为被调用的 API 做了额外的人为设置，允许一个「非同域」的 ajax 请求。<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">跨域资源共享 CORS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 涉及的知识点比较多。我们这里做简单的介绍，目的是让你知道如何在本地开发服务器上增加代理请求的功能。</p> <p>我们在浏览器中看到的页面是从一个本地开发服务器所伺服的。这个本地开发服务器的地址就是 <code>http://localhost:8000/</code> 。当我们调用 getRandomPuzzle 时，此时发送 ajax 请求页面的域就是 <code>http://localhost:8000</code>，但是请求的数据在另外一台服务器 <code>https://08ad1pao69.execute-api.us-east-1.amazonaws.com</code>。一个是 http 一个是 https，路径也不同，端口也不同（https 是 443）。任意这三个东西有一个不同，就认为是资源请求「跨域」了。http 的 <em>默认</em> 安全规则是不允许「跨域」请求。</p> <p>值得注意的是，发送 ajax 请求的是你的浏览器，所谓 User Agent，而「跨域」的限制 <strong>仅仅在浏览器和服务器之间</strong>。我们不能强制远程服务器都像例子中那样允许「跨域」请求，所以我们能做的就是不要使用浏览器发送请求。所以在前端开发中，一种常见的规避跨域的方法就是：把 ajax 请求发送到你的本地开发服务器，然后本地开发服务器再把 ajax 请求转发到远端去，从网络拓扑上看本地开发服务器起着「反向代理」的作用。本地服务器和远端服务器是「服务器和服务器间的通信」，就不存在跨域问题了。</p> <p>配置代理也很简单，只需要您在配置文件 config/config.js 中与 routes 同级处增加 proxy 字段，代码如下，</p> <div class="language-diff extra-class"><pre class="language-diff"><code>   routes: [
   // ...
   ],

<span class="token inserted">+  proxy: {</span>
<span class="token inserted">+    '/dev': {</span>
<span class="token inserted">+      target: 'https://08ad1pao69.execute-api.us-east-1.amazonaws.com',</span>
<span class="token inserted">+      changeOrigin: true,</span>
<span class="token inserted">+    },</span>
<span class="token inserted">+  },</span>
</code></pre></div><p>配置的含义是：去往本地服务器 localhost:8000 的 ajax 调用中，如果是以 <code>/dev</code> 开头的，那么就转发到远端的 <code>https://08ad1pao69.execute-api.us-east-1.amazonaws.com</code> 服务器当中，<code>/dev</code> 也会保留在转发地址中。</p> <p>比如：</p> <p><code>/dev/random_joke</code> 就会被转发到 <code>https://08ad1pao69.execute-api.us-east-1.amazonaws.com/dev/random_joke</code>。</p> <p>所以 end point URI 也需更改为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> endPointURI <span class="token operator">=</span> <span class="token string">'/dev/random_joke'</span><span class="token punctuation">;</span>
</code></pre></div><p>重启 dev server。我们的页面功能没有任何变化，但是发送的 http request 变化了，</p> <p><img src="https://cdn.nlark.com/lark/0/2018/png/58329/1533620989960-e9dd2c6c-0e6e-4222-be67-0b06e045dd83.png" alt="proxy.png | center | 747x333"></p> <p>下图展示了配置代理和不配置代理时请求的路径，</p> <p><img src="https://gw.alipayobjects.com/zos/rmsportal/YiBKIHevTMjvpIAodsOq.png" alt="proxy_server"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/readbook/dsl8ee.html" class="prev">
          搭建基于 model 的卡片列表页面
        </a></span> <span class="next"><a href="/readbook/kmmq56.html">
          模拟服务端数据
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/readbook/assets/js/app.205826b5.js" defer></script><script src="/readbook/assets/js/2.6adc2b3f.js" defer></script><script src="/readbook/assets/js/18.45ae2ea1.js" defer></script>
  </body>
</html>
