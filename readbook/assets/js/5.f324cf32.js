(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{238:function(t,s,a){"use strict";a.r(s);var n=a(2),p=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"深入理解-umi"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#深入理解-umi","aria-hidden":"true"}},[t._v("#")]),t._v(" 深入理解 umi")]),t._v(" "),a("p",[t._v("本文介绍 umi 框架的一些深入概念，帮助大家理解背后的运行机制。")]),t._v(" "),a("p",[t._v("下图是 umi 的架构图，我们试着从此图来一步步理解 umi 。")]),t._v(" "),a("p",[t._v('<img src="https://gw.alipayobjects.com/zos/rmsportal/hawpVKfSgndqDucTgjJQ.png" width="600" />')]),t._v(" "),a("h2",{attrs:{id:"基于路由"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于路由","aria-hidden":"true"}},[t._v("#")]),t._v(" 基于路由")]),t._v(" "),a("p",[t._v("举个 SPA 的例子，比如我们访问 "),a("code",[t._v("/users")]),t._v("，会由 "),a("code",[t._v("./src/pages/users.js")]),t._v(" 决定具体渲染什么，按我们的理解，这其中 "),a("code",[t._v("/users")]),t._v(" 是路由，"),a("code",[t._v("./src/pages/users.js")]),t._v(" 是路由组件，他们俩组成了一个路由配置，然后多个路由配置又形成了一个完整的应用。不难发现，在这个应用里，路由即入口。")]),t._v(" "),a("p",[t._v("umi 是基于路由的，所以具备了管理入口的能力。你甚至可以简单地理解为 umi = 路由 + webpack，当然我们在此基础上做了很多额外的工作。然后，管理了入口之后，能做的事情就很多了。")]),t._v(" "),a("p",[t._v("比如：")]),t._v(" "),a("ul",[a("li",[t._v("开发时按需编译")]),t._v(" "),a("li",[t._v("运行时按需加载，做 code-splitting")]),t._v(" "),a("li",[t._v("智能提取公共代码，加速用户访问，通常是被 路由数/2 引用的模块才被提取到公共代码中")]),t._v(" "),a("li",[t._v("服务端渲染")]),t._v(" "),a("li",[t._v("基于路由的埋点")]),t._v(" "),a("li",[t._v("基于约定，如果 "),a("code",[t._v("./src/pages/404.js")]),t._v(" 存在则添加为 fallback 路由")]),t._v(" "),a("li",[t._v("...")])]),t._v(" "),a("p",[t._v("这里有很大的想象空间。")]),t._v(" "),a("h2",{attrs:{id:"从源码到上线的生命周期管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从源码到上线的生命周期管理","aria-hidden":"true"}},[t._v("#")]),t._v(" 从源码到上线的生命周期管理")]),t._v(" "),a("p",[t._v("市面上的框架基本都是从源码到构建产物，很少会考虑到各种发布流程，而 umi 则多走了这一步。")]),t._v(" "),a("p",[t._v("下图是 umi 从源码到上线的一个流程。")]),t._v(" "),a("p",[t._v('<img src="https://gw.alipayobjects.com/zos/rmsportal/NKsqmTAttwTzYVMJMcnB.png" width="600" />')]),t._v(" "),a("p",[t._v("umi 首先会加载用户的配置和插件，然后基于配置或者目录，生成一份路由配置，再基于此路由配置，把 JS/CSS 源码和 HTML 完整地串联起来。用户配置的参数和插件会影响流程里的每个环节。")]),t._v(" "),a("p",[t._v("举个例子，比如以下目录：")]),t._v(" "),a("pre",[a("code",[t._v("+ src\n  + layouts/index.js\n  + pages\n    - a.js\n    - b.js\n    - 404.js\n")])]),t._v(" "),a("p",[t._v("会生成路由配置如下：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'layouts/index.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  routes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/a'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exact"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pages/a.js'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/b'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exact"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pages/b.js'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pages/404.js'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("以及可运行的代码：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" routes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'layouts/index.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  routes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/a'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exact"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pages/a.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/b'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" exact"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pages/b.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" component"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pages/404.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Router history"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("g_history"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("renderRoutes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("routes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("Router"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("另外，HTML 也是一个很重要的环节，因为他才是真正的入口，js 和 css 都是在 HTML 里发起的。HTML 在 umi 里是一等公民，这意味着我们可以通过插件来调整他的输出，以便和各个后台系统对接，以及打通各种发布流程。")]),t._v(" "),a("p",[t._v("举个例子，我们要配置 webpack externals 掉 react 来优化构建产物，通常我们要做两步：")]),t._v(" "),a("ol",[a("li",[t._v("配置 "),a("code",[t._v("externals: { react: 'window.React' }")])]),t._v(" "),a("li",[t._v("在 html 里引入 "),a("a",{attrs:{href:"https://unpkg.com/react@16.4.1/cjs/react.production.min.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://unpkg.com/react@16.4.1/cjs/react.production.min.js"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("这里的问题是一个功能需要在两个地方维护并且一一对应。然后在 umi 里，由于 HTML 具备插件的能力，所以可以做到你只需要完成第一步，然后 umi 自动帮你做第二步。")]),t._v(" "),a("p",[t._v("最后，通过 umi 可以把各种部署方式封装成插件，实现同一份源码，装载不同的插件，就可以部署到不同平台。比如 umi + umi-plugin-deploy-offline 可以部署为离线包；umi + umi-plugin-deploy-chair 可以部署到 chair 系统。")]),t._v(" "),a("h2",{attrs:{id:"插件机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#插件机制","aria-hidden":"true"}},[t._v("#")]),t._v(" 插件机制")]),t._v(" "),a("p",[t._v("关于 umi 的插件机制你可以阅读 umi 的文档"),a("a",{attrs:{href:"https://umijs.org/zh/plugin/develop.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("《插件开发》"),a("OutboundLink")],1),t._v("来了解更多。")])])},[],!1,null,null,null);s.default=p.exports}}]);